#include "ros/ros.h"
#include "motor_ctrl_20/motor_rece.h"
#include "unitree_motor_ctrl/motor_send.h"
#include "data2float/data2float.h"

unitree_motor_ctrl::motor_send msg;
int i =0;

// float motor_1_pos[] = {-1.57079632679490,	-1.57079632679490,	-1.57079632679490,	-1.56896616826856,	-1.55965558401170,	-1.54025707507073,	-1.51149715731763,	-1.47660397246951,	-1.43981546561551,	-1.41305648758805,	-1.39865575598666,	-1.39589156779995,	-1.40539798295485,	-1.42579860357597,	-1.45415993263780,	-1.48646363069035,	-1.51813093095805,	-1.54469253870732,	-1.56269430613164,	-1.57079632675678};
// float motor_1_speed[] = {0,	3.17744736197076e-23,	0.0183015852633394,	0.0931058425686587,	0.193985089409623,	0.287599177531004,	0.348931848481261,	0.367885068539949,	0.267589780274646,	0.144007316013885,	0.0276418818671390,	-0.0950641515489959,	-0.204006206211221,	-0.283613290618317,	-0.323036980525460,	-0.316673002677045,	-0.265616077492680,	-0.180017674243201,	-0.0810202062514474,	-1.21887361315132e-11};
// float motor_1_tor[] = {1.80023160808495e-17,	0.0334947581317628,	0.0274071085906014,	0.0210650843897718,	0.0124706529242273,	0.00268352937385041	,-0.00569780422948239,	-0.00417111683194999,	-0.00534778904417103,	-0.0195833290906480,	-0.0192863893243600,	-0.0166208404227665,	-0.0128101128781009,	-0.00857369814329486,	-0.00422332511197160,	9.92269774852553e-05,	0.00405817569226307,	0.00694769165108639,	0.00805928755949208,	-0.0735000000024534};
// float motor_2_pos[] = {0,	0,	-7.55121442868737e-27,	0.0246459695469793,	0.0563409381580127,	0.0819318985248353,	0.0913259568558756,	0.0767461489610083,	0.0325076193500734,	-0.0514605676528188,	-0.182996030333963,	-0.342087994406314,	-0.522485662576088,	-0.715777346206902,	-0.911896668987657,	-1.09998715474876,	-1.26939198995737,	-1.41031946414977,	-1.51379333325799,	-1.57079632680602};
// float motor_2_speed[] = { 0,	-7.55121442868737e-26,	0.246459695469793,	0.316949686110334,	0.255909603668226,	0.0939405833104032,	-0.145798078948673,	-0.442385296109349,	-0.839681870028922,	-1.31535462681144,	-1.59091964072351,	-1.80397668169773,	-1.93291683630814,	-1.96119322780755,	-1.88090485761102,	-1.69404835208608,	-1.40927474192403,	-1.03473869108220,	-0.570029935480331,	-5.83194603720472e-11};
// float motor_2_tor[] = {4.50058069253216e-18,	0.0281713031116496,	0.0161882528339664,	0.00728938513201141,	-0.00120683354342180,	-0.00989713988652781,	-0.0180763521520564,	-0.0411826224028760,	-0.0527285536722866,	-0.0348984412563909,	-0.0376113823236162,	-0.0385798264702648,	-0.0381077191920590,	-0.0361995237917504,	-0.0326629060296701,	-0.0273679367921723,	-0.0205311053959216	,-0.0127477747539393,	-0.00458442949676153,	-0.0735000000000000 };

vector<double *>output_vector;

class subandpub
{
private:
    ros::NodeHandle n;
    ros::Publisher pub;
    ros::Subscriber sub;
public:
    subandpub(){
        // pub1 = n1.advertise<unitree_motor_ctrl::motor_send>("/joint/motor1",100);
        pub = n.advertise<unitree_motor_ctrl::motor_send>("/joint/motor1",10);
        sub = n.subscribe<motor_ctrl_20::motor_rece>("motor_pos1",10,&subandpub::domsg2,this);
    }

        void domsg2(const motor_ctrl_20::motor_rece::ConstPtr &p1){
            usleep(20000);
            if(i<20){
            // if(abs(p1->motor1pos-msg.pos1*9.1) < 2 && abs(p1->motor2pos-msg.pos2*9.1) < 2){
                //  msg.pos1 = motor_1_pos[i];
                //  msg.pos2 = motor_2_pos[i];
                //  msg.wrate1 = motor_1_speed[i];
                //  msg.wrate2 = motor_2_speed[i];
                //  msg.tor1 = motor_1_tor[i];
                //  msg.tor2 = motor_2_tor[i];
                msg.pos1 = output_vector[0][i];
                 msg.pos2 = output_vector[1][i];
                 msg.wrate1 = output_vector[4][i];
                 msg.wrate2 = output_vector[5][i];
                 msg.tor1 = output_vector[2][i];
                 msg.tor2 = output_vector[3][i];
                
                 i++;
            // }
            pub.publish(msg);
            }
            ROS_INFO("motor 1 pos is : %f\n",msg.pos1);
            ROS_INFO("motor 2 pos is : %f\n",msg.pos2);
        }
};


// float motor_1_pos[] = {-1.57079632679490,	-1.57079632679490,	-1.57079632679490,	-1.56896616826856,	-1.55965558401170,	-1.54025707507073,	-1.51149715731763,	-1.47660397246951,	-1.43981546561551,	-1.41305648758805,	-1.39865575598666,	-1.39589156779995,	-1.40539798295485,	-1.42579860357597,	-1.45415993263780,	-1.48646363069035,	-1.51813093095805,	-1.54469253870732,	-1.56269430613164,	-1.57079632675678};
// float motor_1_speed[] = {0,	3.17744736197076e-23,	0.0183015852633394,	0.0931058425686587,	0.193985089409623,	0.287599177531004,	0.348931848481261,	0.367885068539949,	0.267589780274646,	0.144007316013885,	0.0276418818671390,	-0.0950641515489959,	-0.204006206211221,	-0.283613290618317,	-0.323036980525460,	-0.316673002677045,	-0.265616077492680,	-0.180017674243201,	-0.0810202062514474,	-1.21887361315132e-11};
// float motor_1_tor[] = {1.80023160808495e-17,	0.0334947581317628,	0.0274071085906014,	0.0210650843897718,	0.0124706529242273,	0.00268352937385041	,-0.00569780422948239,	-0.00417111683194999,	-0.00534778904417103,	-0.0195833290906480,	-0.0192863893243600,	-0.0166208404227665,	-0.0128101128781009,	-0.00857369814329486,	-0.00422332511197160,	9.92269774852553e-05,	0.00405817569226307,	0.00694769165108639,	0.00805928755949208,	-0.0735000000024534};
// float motor_2_pos[] = {0,	0,	-7.55121442868737e-27,	0.0246459695469793,	0.0563409381580127,	0.0819318985248353,	0.0913259568558756,	0.0767461489610083,	0.0325076193500734,	-0.0514605676528188,	-0.182996030333963,	-0.342087994406314,	-0.522485662576088,	-0.715777346206902,	-0.911896668987657,	-1.09998715474876,	-1.26939198995737,	-1.41031946414977,	-1.51379333325799,	-1.57079632680602};
// float motor_2_speed[] = { 0,	-7.55121442868737e-26,	0.246459695469793,	0.316949686110334,	0.255909603668226,	0.0939405833104032,	-0.145798078948673,	-0.442385296109349,	-0.839681870028922,	-1.31535462681144,	-1.59091964072351,	-1.80397668169773,	-1.93291683630814,	-1.96119322780755,	-1.88090485761102,	-1.69404835208608,	-1.40927474192403,	-1.03473869108220,	-0.570029935480331,	-5.83194603720472e-11};
// float motor_2_tor[] = {4.50058069253216e-18,	0.0281713031116496,	0.0161882528339664,	0.00728938513201141,	-0.00120683354342180,	-0.00989713988652781,	-0.0180763521520564,	-0.0411826224028760,	-0.0527285536722866,	-0.0348984412563909,	-0.0376113823236162,	-0.0385798264702648,	-0.0381077191920590,	-0.0361995237917504,	-0.0326629060296701,	-0.0273679367921723,	-0.0205311053959216	,-0.0127477747539393,	-0.00458442949676153,	-0.0735000000000000 };

int main(int argc, char * argv[])
{
    ros::init(argc, argv, "pub_action");
    
    msg.mode1 = 10;
    // msg.tor1 = 0;
    // msg.wrate1 = 0;
    // msg.pos1 = 3.14;
    msg.kp1 = 0.005;
    msg.kw1 = 5;
    msg.mode2 = 10;
    // msg.tor2 = 0;
    // msg.wrate2 = 0;
    // msg.pos2 = 3.14;
    msg.kp2 = 0.005;
    msg.kw2 = 5;
    
    string file = "/home/skelon/unitree/src/motor_ctrl_20/data.txt";
    int columns = 20;
    int rows = output_vector.size();
    read_scanf(file,columns,output_vector);
    // ros::NodeHandle n1;
    // ros::Publisher pub1 = n1.advertise<unitree_motor_ctrl::motor_send>("/joint/motor1",10);
    
    // ros::Duration(1.0).sleep();
    // // double t0 = ros::Time::now().toSec();
    // // while(ros::Time::now().toSec() < t0+1){
    // //     pub1.publish(msg);
    // // }
    
    
    // pub1.publish(msg);
    ROS_INFO("11111111111");
    subandpub tt;
    ROS_INFO("2222222222");
    ros::spin();
    ROS_INFO("3333333333");
    // ros::spin();
    // ros::AsyncSpinner spinner(2);
    // spinner.start();
    // ros::waitForShutdown();
    
    return 0;
}
